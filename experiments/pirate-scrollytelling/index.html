<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Último Pirata - La Tormenta</title>
    
    <!-- Three.js moderno (misma versión que pirate-island-scene) -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    
    <!-- GSAP + ScrollTrigger -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Georgia', serif;
            background: #000;
            color: #fff;
            overflow-x: hidden;
        }

        /* Canvas 3D */
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }

        #webgl-canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* Overlay para transiciones */
        #fade-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 50;
            pointer-events: none;
            opacity: 0;
        }

        /* Panel de texto fijo arriba */
        #story-panel {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            max-width: 600px;
            width: 90%;
        }

        .text-overlay {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            padding: 1.5rem 2rem;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        .text-overlay.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .story-title {
            font-size: 1.8rem;
            margin-bottom: 0.8rem;
            background: linear-gradient(135deg, #f39c12, #e74c3c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        h2 {
            font-size: 1.6rem;
            margin-bottom: 0.8rem;
            color: #fff;
        }

        .story-text {
            font-size: 1rem;
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 0.5rem;
        }

        .dialogue {
            font-style: italic;
            color: #f39c12;
            font-size: 0.95rem;
            margin: 0.5rem 0;
            padding: 0.3rem 0.8rem;
            border-left: 2px solid #f39c12;
            text-align: left;
        }

        .dialogue strong {
            color: #fff;
            font-style: normal;
        }

        .story-ending {
            font-size: 1.1rem;
            font-style: italic;
            color: #f1c40f;
            margin: 1rem 0;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Contenedor de scroll - ahora invisible pero funcional */
        #scroll-container {
            position: relative;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
        }

        /* Secciones de historia - solo para scroll trigger */
        .story-section {
            min-height: 300vh;
            width: 100%;
            position: relative;
        }

        #restart-btn {
            background: linear-gradient(135deg, #f39c12, #e74c3c);
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 1rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        #restart-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(243, 156, 18, 0.4);
        }

        /* Barra de progreso */
        #progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            z-index: 100;
        }

        #progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #f39c12, #e74c3c);
            transition: width 0.1s linear;
        }

        /* Navegación */
        #scene-nav {
            position: fixed;
            right: 2rem;
            top: 50%;
            transform: translateY(-50%);
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .nav-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-dot:hover {
            background: rgba(255, 255, 255, 0.6);
            transform: scale(1.2);
        }

        .nav-dot.active {
            background: #f39c12;
            transform: scale(1.3);
            box-shadow: 0 0 20px rgba(243, 156, 18, 0.5);
        }

        /* Instrucciones */
        #instructions {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-radius: 50px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            animation: bounce 2s infinite;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        @keyframes bounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }

        /* Loading */
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: rgba(0, 0, 0, 0.95);
            padding: 40px 60px;
            border-radius: 20px;
            text-align: center;
            border: 1px solid rgba(243, 156, 18, 0.3);
        }

        #loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(243, 156, 18, 0.3);
            border-top-color: #f39c12;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .story-title { font-size: 2rem; }
            h2 { font-size: 1.8rem; }
            .story-text { font-size: 1rem; }
            .text-overlay { padding: 1.5rem; margin: 1rem; }
            .dialogue { font-size: 1rem; }
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div id="loading">
        <div id="loading-spinner"></div>
        <div style="color: #f39c12; font-size: 1.2rem;">Cargando aventura pirata...</div>
        <div id="loading-text" style="font-size: 14px; margin-top: 10px; color: #888;">Preparando el barco</div>
    </div>

    <!-- Fade Overlay para transiciones -->
    <div id="fade-overlay"></div>

    <!-- Canvas 3D -->
    <div id="canvas-container">
        <canvas id="webgl-canvas"></canvas>
    </div>
    
    <!-- Panel de historia fijo arriba -->
    <div id="story-panel">
        <div class="text-overlay visible" id="scene-text-1">
            <h1 class="story-title">El Último Pirata</h1>
            <p class="story-text">
                En medio del océano infinito, el Capitán Barbarossa navegaba solo. 
                Una tormenta furiosa amenazaba con tragar su barco.
            </p>
            <div class="dialogue">
                <strong>Barbarossa:</strong> "¡Maldita sea esta tormenta! ¿Dónde encontraré ahora una tripulación valiente?"
            </div>
        </div>
        
        <div class="text-overlay" id="scene-text-2">
            <h2>El Puerto de Tortuga</h2>
            <p class="story-text">
                Con la tormenta calmada, Barbarossa zarparía hacia el Puerto de Tortuga, 
                el lugar más peligroso del Caribe.
            </p>
            <div class="dialogue">
                <strong>Anne:</strong> "¿Necesitas una navegadora? Sé leer las estrellas mejor que nadie."
            </div>
        </div>
        
        <div class="text-overlay" id="scene-text-3">
            <h2>La Jungla Maldita</h2>
            <p class="story-text">
                Después de días navegando, llegaron a una isla cubierta de vegetación densa. 
                Los árboles gigantes formaban un túnel oscuro.
            </p>
            <div class="dialogue">
                <strong>Skeleton:</strong> "A mí me parece acogedor. Como en casa."
            </div>
        </div>
        
        <div class="text-overlay" id="scene-text-4">
            <h2>La Cueva del Kraken</h2>
            <p class="story-text">
                Del agua negra emergieron tentáculos gigantes. 
                El guardián del tesoro no iba a rendirse sin lucha.
            </p>
            <div class="dialogue">
                <strong>Barbarossa:</strong> "¡A las armas, malditos! ¡Por el botín!"
            </div>
        </div>
        
        <div class="text-overlay" id="scene-text-5">
            <h2>La Fortuna del Caribe</h2>
            <p class="story-text">
                El cofre se abrió con un chirrido glorioso. Dentro había más oro 
                del que podían imaginar.
            </p>
            <p class="story-ending">
                Y así, el Capitán Barbarossa y su improbable tripulación 
                se convirtieron en las leyendas más grandes de los siete mares.
            </p>
            <button id="restart-btn">⚓ Volver a zarpar</button>
        </div>
    </div>
    
    <!-- Barra de progreso -->
    <div id="progress-bar">
        <div id="progress-fill"></div>
    </div>
    
    <!-- Navegación -->
    <nav id="scene-nav">
        <div class="nav-dot active" data-scene="0"></div>
        <div class="nav-dot" data-scene="1"></div>
        <div class="nav-dot" data-scene="2"></div>
        <div class="nav-dot" data-scene="3"></div>
        <div class="nav-dot" data-scene="4"></div>
    </nav>

    <!-- Secciones de scroll (invisibles pero funcionales) -->
    <main id="scroll-container">
        <section class="story-section" id="scene1"></section>
        <section class="story-section" id="scene2"></section>
        <section class="story-section" id="scene3"></section>
        <section class="story-section" id="scene4"></section>
        <section class="story-section" id="scene5"></section>
    </main>

    <!-- Instrucciones -->
    <div id="instructions">
        <span>Desplázate para vivir la aventura</span>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        
        // Hacer THREE disponible globalmente para compatibilidad
        window.THREE = THREE;
        
        // ============================================
        // CONFIGURACIÓN GLOBAL
        // ============================================
        const CONFIG = {
            cameraSmoothness: 0.05,
            models: {
                // Personajes
                barbarossa: '../../assets/3D/pirate-kit/glTF/Characters_Captain_Barbarossa.gltf',
                anne: '../../assets/3D/pirate-kit/glTF/Characters_Anne.gltf',
                henry: '../../assets/3D/pirate-kit/glTF/Characters_Henry.gltf',
                skeleton: '../../assets/3D/pirate-kit/glTF/Characters_Skeleton.gltf',
                tentacle: '../../assets/3D/pirate-kit/glTF/Characters_Tentacle.gltf',
                enemyTentacle: '../../assets/3D/pirate-kit/glTF/Enemy_Tentacle.gltf',
                // Barcos
                shipLarge: '../../assets/3D/pirate-kit/glTF/Ship_Large.gltf',
                shipSmall: '../../assets/3D/pirate-kit/glTF/Ship_Small.gltf',
                // Environment
                dock: '../../assets/3D/pirate-kit/glTF/Environment_Dock.gltf',
                dockPole: '../../assets/3D/pirate-kit/glTF/Environment_Dock_Pole.gltf',
                house1: '../../assets/3D/pirate-kit/glTF/Environment_House1.gltf',
                house2: '../../assets/3D/pirate-kit/glTF/Environment_House2.gltf',
                cliff1: '../../assets/3D/pirate-kit/glTF/Environment_Cliff1.gltf',
                cliff2: '../../assets/3D/pirate-kit/glTF/Environment_Cliff2.gltf',
                cliff3: '../../assets/3D/pirate-kit/glTF/Environment_Cliff3.gltf',
                palmTree1: '../../assets/3D/pirate-kit/glTF/Environment_PalmTree_1.gltf',
                palmTree2: '../../assets/3D/pirate-kit/glTF/Environment_PalmTree_2.gltf',
                palmTree3: '../../assets/3D/pirate-kit/glTF/Environment_PalmTree_3.gltf',
                largeBones: '../../assets/3D/pirate-kit/glTF/Environment_LargeBones.gltf',
                rock1: '../../assets/3D/pirate-kit/glTF/Environment_Rock_1.gltf',
                rock2: '../../assets/3D/pirate-kit/glTF/Environment_Rock_2.gltf',
                rock3: '../../assets/3D/pirate-kit/glTF/Environment_Rock_3.gltf',
                // Props
                chestGold: '../../assets/3D/pirate-kit/glTF/Prop_Chest_Gold.gltf',
                coins: '../../assets/3D/pirate-kit/glTF/Prop_Coins.gltf',
                goldBag: '../../assets/3D/pirate-kit/glTF/Prop_GoldBag.gltf',
                barrel: '../../assets/3D/pirate-kit/glTF/Prop_Barrel.gltf',
                skull: '../../assets/3D/pirate-kit/glTF/Prop_Skull.gltf',
                cannon: '../../assets/3D/pirate-kit/glTF/Prop_Cannon.gltf',
                // Weapons
                cutlass: '../../assets/3D/pirate-kit/glTF/Weapon_Cutlass.gltf',
                sword: '../../assets/3D/pirate-kit/glTF/Weapon_Sword_1.gltf',
                // Nature kit extras
                treeOak: '../../assets/3D/kenney_nature-kit/Models/GLTF format/tree_oak.glb',
                treeDetailed: '../../assets/3D/kenney_nature-kit/Models/GLTF format/tree_detailed.glb',
                treePineTall: '../../assets/3D/kenney_nature-kit/Models/GLTF format/tree_pineTallA.glb',
                rockLarge: '../../assets/3D/kenney_nature-kit/Models/GLTF format/rock_largeA.glb',
                plantBushLarge: '../../assets/3D/kenney_nature-kit/Models/GLTF format/plant_bushLarge.glb'
            }
        };

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let scene, camera, renderer;
        let loadedModels = {};
        let animatedCharacters = [];
        let mixers = [];
        let scrollProgress = 0;
        let animationId;
        let lights = {};
        
        // Grupos de escenas
        let sceneGroups = {
            storm: null,      // Escena 1: La Tormenta
            port: null,       // Escena 2: El Puerto
            jungle: null,     // Escena 3: La Jungla
            cave: null,       // Escena 4: La Cueva
            beach: null       // Escena 5: La Playa
        };
        
        let currentScene = 1;
        let isTransitioning = false;
        
        // Efectos especiales escena 1
        let rainSystem, lightningLight, stormTime = 0;
        let shipInStorm;

        // ============================================
        // INICIALIZACIÓN
        // ============================================
        function init() {
            setupThreeJS();
            setupLights();
            
            loadAllModels().then(() => {
                setTimeout(() => {
                    createSceneGroups();
                    setupScrollAnimations();
                    animate();
                    updateNavigationDots(0);
                    updateSceneText(1); // Mostrar texto de escena 1 al inicio
                    
                    setTimeout(() => {
                        const instructions = document.getElementById('instructions');
                        if (instructions) instructions.style.opacity = '0';
                    }, 5000);
                }, 100);
            });
            
            window.addEventListener('resize', onWindowResize);
            
            const restartBtn = document.getElementById('restart-btn');
            if (restartBtn) restartBtn.addEventListener('click', restartStory);
            
            setupNavigationDots();
        }

        // ============================================
        // THREE.JS SETUP
        // ============================================
        function setupThreeJS() {
            const canvas = document.getElementById('webgl-canvas');
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2e);
            scene.fog = new THREE.FogExp2(0x1a1a2e, 0.015);
            
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 12, 30);
            
            renderer = new THREE.WebGLRenderer({
                canvas: canvas,
                antialias: true,
                alpha: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.0;
        }

        // ============================================
        // LUCES
        // ============================================
        function setupLights() {
            // Luz ambiental base (oscura para la tormenta)
            lights.ambient = new THREE.AmbientLight(0x1a1a2e, 0.3);
            scene.add(lights.ambient);
            
            // Luz de luna (fría, azulada)
            lights.moon = new THREE.DirectionalLight(0xa8d8ea, 0.4);
            lights.moon.position.set(20, 30, -20);
            lights.moon.castShadow = true;
            lights.moon.shadow.mapSize.width = 2048;
            lights.moon.shadow.mapSize.height = 2048;
            scene.add(lights.moon);
            
            // Luz de relleno
            lights.fill = new THREE.DirectionalLight(0x2d3561, 0.3);
            lights.fill.position.set(-20, 10, 20);
            scene.add(lights.fill);
            
            // Luz de relámpago (inicialmente apagada)
            lightningLight = new THREE.PointLight(0xffffff, 0, 100);
            lightningLight.position.set(0, 30, 0);
            scene.add(lightningLight);
            
            // La iluminación de la tormenta viene de los relámpagos intermitentes (lightningLight)
            // No necesitamos luz fija adicional, solo los flashes eléctricos
        }

        // ============================================
        // CARGA DE MODELOS
        // ============================================
        function loadAllModels() {
            return new Promise((resolve) => {
                const loader = new GLTFLoader();
                const modelNames = Object.keys(CONFIG.models);
                let loadedCount = 0;
                const total = modelNames.length;
                
                document.getElementById('loading-text').textContent = `0/${total} modelos cargados`;
                
                modelNames.forEach(name => {
                    const path = CONFIG.models[name];
                    
                    loader.load(
                        path,
                        (gltf) => {
                            loadedModels[name] = gltf.scene;
                            
                            if (gltf.animations && gltf.animations.length > 0) {
                                loadedModels[name + '_animations'] = gltf.animations;
                            }
                            
                            gltf.scene.traverse((child) => {
                                if (child.isMesh) {
                                    child.castShadow = true;
                                    child.receiveShadow = true;
                                }
                            });
                            
                            loadedCount++;
                            document.getElementById('loading-text').textContent = 
                                `${loadedCount}/${total} modelos cargados`;
                            
                            if (loadedCount === total) {
                                document.getElementById('loading').classList.add('hidden');
                                resolve();
                            }
                        },
                        undefined,
                        (error) => {
                            console.warn(`Error cargando ${name}:`, error);
                            loadedModels[name] = createFallbackGeometry(name);
                            loadedCount++;
                            if (loadedCount === total) {
                                document.getElementById('loading').classList.add('hidden');
                                resolve();
                            }
                        }
                    );
                });
            });
        }

        function createFallbackGeometry(type) {
            const group = new THREE.Group();
            let geometry, material, mesh;
            
            if (type.includes('barbarossa') || type.includes('anne') || type.includes('henry')) {
                geometry = new THREE.CapsuleGeometry(0.5, 1.5, 4, 8);
                material = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
                mesh = new THREE.Mesh(geometry, material);
                mesh.position.y = 0.75;
            } else if (type.includes('skeleton')) {
                geometry = new THREE.CapsuleGeometry(0.4, 1.4, 4, 8);
                material = new THREE.MeshStandardMaterial({ color: 0xdddddd });
                mesh = new THREE.Mesh(geometry, material);
                mesh.position.y = 0.7;
            } else if (type.includes('tentacle')) {
                geometry = new THREE.CylinderGeometry(0.3, 0.1, 3, 8);
                material = new THREE.MeshStandardMaterial({ color: 0x8B008B });
                mesh = new THREE.Mesh(geometry, material);
                mesh.position.y = 1.5;
            } else if (type.includes('ship')) {
                geometry = new THREE.BoxGeometry(4, 1.5, 8);
                material = new THREE.MeshStandardMaterial({ color: 0x5c4033 });
                mesh = new THREE.Mesh(geometry, material);
                mesh.position.y = 0.75;
            } else if (type.includes('chest')) {
                geometry = new THREE.BoxGeometry(1.5, 1, 1);
                material = new THREE.MeshStandardMaterial({ color: 0xFFD700 });
                mesh = new THREE.Mesh(geometry, material);
                mesh.position.y = 0.5;
            } else if (type.includes('tree')) {
                // Tronco
                const trunk = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.3, 0.5, 2, 8),
                    new THREE.MeshStandardMaterial({ color: 0x8B4513 })
                );
                trunk.position.y = 1;
                group.add(trunk);
                // Copa
                const leaves = new THREE.Mesh(
                    new THREE.ConeGeometry(2, 4, 8),
                    new THREE.MeshStandardMaterial({ color: 0x228B22 })
                );
                leaves.position.y = 3;
                group.add(leaves);
            } else {
                geometry = new THREE.BoxGeometry(1, 1, 1);
                material = new THREE.MeshStandardMaterial({ color: 0x808080 });
                mesh = new THREE.Mesh(geometry, material);
            }
            
            if (mesh) group.add(mesh);
            return group;
        }

        // ============================================
        // CREACIÓN DE GRUPOS DE ESCENAS
        // ============================================
        function createSceneGroups() {
            // Crear grupos para cada escena
            sceneGroups.storm = new THREE.Group();
            sceneGroups.port = new THREE.Group();
            sceneGroups.jungle = new THREE.Group();
            sceneGroups.cave = new THREE.Group();
            sceneGroups.beach = new THREE.Group();
            
            // Inicialmente solo mostrar escena 1
            scene.add(sceneGroups.storm);
            sceneGroups.port.visible = false;
            sceneGroups.jungle.visible = false;
            sceneGroups.cave.visible = false;
            sceneGroups.beach.visible = false;
            scene.add(sceneGroups.port);
            scene.add(sceneGroups.jungle);
            scene.add(sceneGroups.cave);
            scene.add(sceneGroups.beach);
            
            // Construir cada escena
            buildStormScene();
            buildPortScene();
            buildJungleScene();
            buildCaveScene();
            buildBeachScene();
        }

        // ============================================
        // ESCENA 1: LA TORMENTA
        // ============================================
        function buildStormScene() {
            const group = sceneGroups.storm;
            
            // Agua tormentosa
            const waterGeometry = new THREE.PlaneGeometry(300, 300, 64, 64);
            const waterMaterial = new THREE.MeshStandardMaterial({
                color: 0x001f3f,
                roughness: 0.1,
                metalness: 0.8,
                transparent: true,
                opacity: 0.9,
                emissive: 0x001122,
                emissiveIntensity: 0.2
            });
            const water = new THREE.Mesh(waterGeometry, waterMaterial);
            water.rotation.x = -Math.PI / 2;
            water.position.y = -1;
            water.receiveShadow = true;
            group.add(water);
            
            // Barco grande
            shipInStorm = loadedModels.shipLarge.clone();
            shipInStorm.position.set(0, 0, 0);
            shipInStorm.scale.set(1.2, 1.2, 1.2);
            shipInStorm.rotation.y = 0.3;
            group.add(shipInStorm);

            const DECK_LEVEL = 1.2; // Altura aproximada de la cubierta del barco  
            
            // Barbarossa en cubierta - SIMPLIFICADO como en scene1.html
            console.log('=== CARGANDO CAPITÁN BARBAROSSA (SIMPLIFICADO) ===');
            
            if (loadedModels['barbarossa']) {
                // Usar el modelo directamente como en scene1 (no clonar innecesariamente)
                const captainModel = loadedModels['barbarossa'];
                
                // Posición: en la cubierta del barco
                // Los barriles están en Y=DECK_LEVEL, el capitán debería estar a la misma altura
                captainModel.position.set(0, DECK_LEVEL, 0);
                captainModel.rotation.y = -0.5;
                captainModel.visible = true;
                
                // Solo asegurar que es visible (sin complicaciones)
                captainModel.traverse((child) => {
                    child.visible = true;
                });
                
                // Añadir al grupo de la escena
                //group.add(captainModel);
                shipInStorm.add(captainModel);
                
                // Animación Idle
                const animations = loadedModels['barbarossa_animations'];
                if (animations && animations.length > 0) {
                    const mixer = new THREE.AnimationMixer(captainModel);
                    mixers.push(mixer);
                    
                    const idleAnim = animations.find(a => a.name === 'Idle');
                    if (idleAnim) {
                        mixer.clipAction(idleAnim).play();
                    }
                    
                    window.barbarossaInStorm = {
                        model: captainModel,
                        mixer: mixer
                    };
                }
                
                console.log('Capitán añadido en posición:', captainModel.position);
            }

            
            // Barriles rodando en cubierta (como hijos del barco)
            const barrel1 = loadedModels.barrel.clone();
            barrel1.position.set(-1, DECK_LEVEL, 0);
            barrel1.rotation.set(0.5, 0, 0.3);
            shipInStorm.add(barrel1);
            
            const barrel2 = loadedModels.barrel.clone();
            barrel2.position.set(2.5, DECK_LEVEL, 0);
            barrel2.rotation.set(0.3, 0.5, 0);
            shipInStorm.add(barrel2);
            
            const barrel3 = loadedModels.barrel.clone();
            barrel3.position.set(-1, DECK_LEVEL, 1);
            barrel3.rotation.set(0.4, 0, -0.2);
            shipInStorm.add(barrel3);
            
            // DEBUG: Ver dimensiones del barco
            const box = new THREE.Box3().setFromObject(shipInStorm);
            const size = box.getSize(new THREE.Vector3());
            console.log('Dimensiones del barco:', size);
            console.log('Centro del barco:', box.getCenter(new THREE.Vector3()));
            
            // Islas lejanas (siluetas)
            for (let i = 0; i < 5; i++) {
                const palm = loadedModels.palmTree1.clone();
                palm.position.set(
                    (Math.random() - 0.5) * 100,
                    -1,
                    -60 - Math.random() * 30
                );
                palm.scale.setScalar(0.6 + Math.random() * 0.4);
                palm.rotation.y = Math.random() * Math.PI * 2;
                // Oscurecer para efecto silueta
                palm.traverse((child) => {
                    if (child.isMesh && child.material) {
                        child.material = child.material.clone();
                        child.material.color.setHex(0x0a0a15);
                    }
                });
                group.add(palm);
            }
            
            // Sistema de lluvia
            createRainSystem(group);
        }

        function createRainSystem(group) {
            const rainCount = 1500;
            const rainGeometry = new THREE.BufferGeometry();
            const rainPositions = new Float32Array(rainCount * 3);
            const rainVelocities = [];
            
            for (let i = 0; i < rainCount; i++) {
                rainPositions[i * 3] = (Math.random() - 0.5) * 80;
                rainPositions[i * 3 + 1] = Math.random() * 40;
                rainPositions[i * 3 + 2] = (Math.random() - 0.5) * 80;
                
                rainVelocities.push({
                    x: -0.3 + Math.random() * 0.2, // Viento
                    y: -0.5 - Math.random() * 0.3, // Caída
                    z: 0
                });
            }
            
            rainGeometry.setAttribute('position', new THREE.BufferAttribute(rainPositions, 3));
            
            const rainMaterial = new THREE.PointsMaterial({
                color: 0x88aaff,
                size: 0.15,
                transparent: true,
                opacity: 0.6,
                blending: THREE.AdditiveBlending
            });
            
            rainSystem = new THREE.Points(rainGeometry, rainMaterial);
            rainSystem.userData = { velocities: rainVelocities };
            group.add(rainSystem);
        }

        // ============================================
        // ESCENA 2: EL PUERTO DORADO
        // ============================================
        function buildPortScene() {
            const group = sceneGroups.port;
            
            // Suelo de arena/muelle
            const groundGeometry = new THREE.PlaneGeometry(200, 200);
            const groundMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xC2B280,
                roughness: 0.9
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -0.1;
            ground.receiveShadow = true;
            group.add(ground);
            
            // Agua cristalina
            const waterGeometry = new THREE.PlaneGeometry(300, 300);
            const waterMaterial = new THREE.MeshStandardMaterial({
                color: 0x40E0D0,
                roughness: 0.1,
                metalness: 0.3,
                transparent: true,
                opacity: 0.8
            });
            const water = new THREE.Mesh(waterGeometry, waterMaterial);
            water.rotation.x = -Math.PI / 2;
            water.position.y = -0.5;
            group.add(water);
            
            // Muelle
            for (let i = -2; i <= 2; i++) {
                const dock = loadedModels.dock.clone();
                dock.position.set(i * 4, 0, 0);
                group.add(dock);
                
                // Postes
                const pole1 = loadedModels.dockPole.clone();
                pole1.position.set(i * 4 + 1.5, 0, 1.5);
                group.add(pole1);
                
                const pole2 = loadedModels.dockPole.clone();
                pole2.position.set(i * 4 + 1.5, 0, -1.5);
                group.add(pole2);
            }
            
            // Casas de fondo
            const house1 = loadedModels.house1.clone();
            house1.position.set(-20, 0, -15);
            house1.rotation.y = 0.3;
            group.add(house1);
            
            const house2 = loadedModels.house2.clone();
            house2.position.set(25, 0, -12);
            house2.rotation.y = -0.2;
            group.add(house2);
            
            const house3 = loadedModels.house1.clone();
            house3.position.set(30, 0, -20);
            house3.rotation.y = -0.4;
            group.add(house3);
            
            // Barcos pequeños amarrados
            const ship1 = loadedModels.shipSmall.clone();
            ship1.position.set(-12, -0.2, 8);
            ship1.rotation.y = 0.5;
            group.add(ship1);
            
            const ship2 = loadedModels.shipSmall.clone();
            ship2.position.set(15, -0.2, 10);
            ship2.rotation.y = -0.3;
            group.add(ship2);
            
            // Barco grande de Barbarossa
            const shipLarge = loadedModels.shipLarge.clone();
            shipLarge.position.set(0, -0.3, 15);
            shipLarge.rotation.y = 3.14;
            shipLarge.scale.set(0.8, 0.8, 0.8);
            group.add(shipLarge);
            
            // Personajes (inicialmente ocultos)
            const barbarossa = createAnimatedCharacter('barbarossa', group, { x: 0, y: 0, z: 0 }, 1);
            if (barbarossa) {
                barbarossa.model.visible = false;
            }
            
            const anne = createAnimatedCharacter('anne', group, { x: 6, y: 0, z: 2 }, 1);
            if (anne) {
                anne.model.visible = false;
            }
            
            const henry = createAnimatedCharacter('henry', group, { x: 10, y: 0, z: -2 }, 1);
            if (henry) {
                henry.model.visible = false;
            }
            
            const skeleton = createAnimatedCharacter('skeleton', group, { x: -5, y: 0, z: 5 }, 1);
            if (skeleton) {
                skeleton.model.visible = false;
                skeleton.model.scale.set(0, 0, 0);
            }
            
            // Props del muelle
            for (let i = 0; i < 8; i++) {
                const barrel = loadedModels.barrel.clone();
                barrel.position.set(
                    (Math.random() - 0.5) * 15,
                    0,
                    (Math.random() - 0.5) * 8
                );
                if (Math.random() > 0.5) {
                    barrel.position.y = 0.8;
                    barrel.rotation.z = Math.random() * 0.5;
                }
                group.add(barrel);
            }
            
            // Botellas dispersas
            const bottle1 = loadedModels.barrel.clone(); // Fallback
            bottle1.position.set(3, 0, 3);
            bottle1.scale.set(0.3, 0.5, 0.3);
            group.add(bottle1);
            
            // Palmeras
            for (let i = 0; i < 8; i++) {
                const palmType = Math.random() > 0.6 ? 'palmTree1' : Math.random() > 0.5 ? 'palmTree2' : 'palmTree3';
                const palm = loadedModels[palmType].clone();
                palm.position.set(
                    -40 + Math.random() * 80,
                    0,
                    -25 - Math.random() * 15
                );
                palm.scale.setScalar(0.8 + Math.random() * 0.5);
                palm.rotation.y = Math.random() * Math.PI * 2;
                group.add(palm);
            }
        }

        // ============================================
        // ESCENA 3: LA JUNGLA MALDITA
        // ============================================
        function buildJungleScene() {
            const group = sceneGroups.jungle;
            
            // Suelo de tierra/jungle
            const groundGeometry = new THREE.PlaneGeometry(200, 200);
            const groundMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x3d5c3d,
                roughness: 0.95
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -0.1;
            ground.receiveShadow = true;
            group.add(ground);
            
            // Árboles grandes formando un túnel
            for (let i = 0; i < 20; i++) {
                const treeType = Math.random() > 0.5 ? 'treeOak' : 'treeDetailed';
                const tree = loadedModels[treeType].clone();
                const angle = (i / 20) * Math.PI * 2;
                const radius = 15 + Math.random() * 10;
                tree.position.set(
                    Math.cos(angle) * radius,
                    0,
                    Math.sin(angle) * radius - 10
                );
                tree.scale.setScalar(2 + Math.random() * 1);
                tree.rotation.y = Math.random() * Math.PI * 2;
                group.add(tree);
            }
            
            // Pinos altos
            for (let i = 0; i < 15; i++) {
                const pine = loadedModels.treePineTall.clone();
                pine.position.set(
                    (Math.random() - 0.5) * 60,
                    0,
                    (Math.random() - 0.5) * 60
                );
                pine.scale.setScalar(1.5 + Math.random() * 0.8);
                group.add(pine);
            }
            
            // Huesos gigantes
            const bones1 = loadedModels.largeBones.clone();
            bones1.position.set(-8, 0, -5);
            bones1.scale.set(1.8, 1.8, 1.8);
            bones1.rotation.y = 0.5;
            group.add(bones1);
            
            const bones2 = loadedModels.largeBones.clone();
            bones2.position.set(12, 0, 8);
            bones2.scale.set(1.5, 1.5, 1.5);
            bones2.rotation.y = -0.8;
            group.add(bones2);
            
            // Calaveras dispersas
            for (let i = 0; i < 12; i++) {
                const skull = loadedModels.skull.clone();
                skull.position.set(
                    (Math.random() - 0.5) * 30,
                    0.2,
                    (Math.random() - 0.5) * 30
                );
                skull.scale.set(0.3, 0.3, 0.3);
                skull.rotation.y = Math.random() * Math.PI * 2;
                group.add(skull);
            }
            
            // Rocas
            for (let i = 0; i < 10; i++) {
                const rockType = ['rockLarge', 'rock1', 'rock2'][Math.floor(Math.random() * 3)];
                const rock = loadedModels[rockType].clone();
                rock.position.set(
                    (Math.random() - 0.5) * 50,
                    0,
                    (Math.random() - 0.5) * 50
                );
                rock.scale.setScalar(1 + Math.random() * 1.5);
                group.add(rock);
            }
            
            // Arbustos
            for (let i = 0; i < 20; i++) {
                const bush = loadedModels.plantBushLarge.clone();
                bush.position.set(
                    (Math.random() - 0.5) * 40,
                    0,
                    (Math.random() - 0.5) * 40
                );
                bush.rotation.y = Math.random() * Math.PI * 2;
                group.add(bush);
            }
            
            // Armas tiradas
            const cutlass = loadedModels.cutlass.clone();
            cutlass.position.set(3, 0, 2);
            cutlass.rotation.set(1.5, 0.5, 0);
            group.add(cutlass);
            
            const sword = loadedModels.sword.clone();
            sword.position.set(-4, 0, 5);
            sword.rotation.set(1.2, -0.3, 0);
            group.add(sword);
            
            // Personajes (inicialmente fuera)
            const barbarossa = createAnimatedCharacter('barbarossa', group, { x: 0, y: 0, z: 10 }, 1);
            const anne = createAnimatedCharacter('anne', group, { x: -3, y: 0, z: 12 }, 1);
            const henry = createAnimatedCharacter('henry', group, { x: 3, y: 0, z: 11 }, 1);
            const skeleton = createAnimatedCharacter('skeleton', group, { x: 1, y: 0, z: 13 }, 1);
        }

        // ============================================
        // ESCENA 4: LA CUEVA DEL KRAKEN
        // ============================================
        function buildCaveScene() {
            const group = sceneGroups.cave;
            
            // Suelo rocoso con agua
            const groundGeometry = new THREE.PlaneGeometry(100, 100);
            const groundMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x2a2a3a,
                roughness: 0.9
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -0.1;
            group.add(ground);
            
            // Agua reflectante
            const waterGeometry = new THREE.PlaneGeometry(80, 80);
            const waterMaterial = new THREE.MeshStandardMaterial({
                color: 0x0a0a1a,
                roughness: 0.05,
                metalness: 0.9,
                transparent: true,
                opacity: 0.9
            });
            const water = new THREE.Mesh(waterGeometry, waterMaterial);
            water.rotation.x = -Math.PI / 2;
            water.position.y = -0.05;
            group.add(water);
            
            // Paredes de cueva (acantilados)
            const cliff1 = loadedModels.cliff1.clone();
            cliff1.position.set(-25, 0, -20);
            cliff1.scale.set(3, 2.5, 3);
            group.add(cliff1);
            
            const cliff2 = loadedModels.cliff2.clone();
            cliff2.position.set(30, 0, -15);
            cliff2.scale.set(2.8, 2.3, 2.8);
            group.add(cliff2);
            
            const cliff3 = loadedModels.cliff3.clone();
            cliff3.position.set(-20, 0, 25);
            cliff3.scale.set(2.5, 2, 2.5);
            group.add(cliff3);
            
            // Paredes laterales
            for (let i = 0; i < 5; i++) {
                const cliff = loadedModels.cliff1.clone();
                cliff.position.set(-35 + i * 3, 0, -10 + i * 5);
                cliff.scale.set(2, 3, 2);
                cliff.rotation.y = Math.PI / 2;
                group.add(cliff);
            }
            
            // Cofre del tesoro
            const chest = loadedModels.chestGold.clone();
            chest.position.set(0, 0.5, -8);
            chest.scale.set(1.2, 1.2, 1.2);
            group.add(chest);
            
            // Gemas brillantes (luces de colores)
            const gemColors = [0x00ffff, 0xff00ff, 0xffff00, 0x00ff00];
            for (let i = 0; i < 15; i++) {
                const gem = new THREE.Mesh(
                    new THREE.OctahedronGeometry(0.2, 0),
                    new THREE.MeshStandardMaterial({
                        color: gemColors[i % 4],
                        emissive: gemColors[i % 4],
                        emissiveIntensity: 0.5
                    })
                );
                gem.position.set(
                    (Math.random() - 0.5) * 40,
                    2 + Math.random() * 8,
                    (Math.random() - 0.5) * 40
                );
                group.add(gem);
                
                // Luz de gema
                const gemLight = new THREE.PointLight(gemColors[i % 4], 0.5, 8);
                gemLight.position.copy(gem.position);
                group.add(gemLight);
            }
            
            // Monedas dispersas
            for (let i = 0; i < 15; i++) {
                const coins = loadedModels.coins.clone();
                coins.position.set(
                    (Math.random() - 0.5) * 10,
                    0,
                    -5 + (Math.random() - 0.5) * 8
                );
                coins.scale.setScalar(0.4 + Math.random() * 0.3);
                group.add(coins);
            }
            
            // Cañones
            const cannon1 = loadedModels.cannon.clone();
            cannon1.position.set(-8, 0, 2);
            cannon1.rotation.y = 2.5;
            group.add(cannon1);
            
            const cannon2 = loadedModels.cannon.clone();
            cannon2.position.set(8, 0, 0);
            cannon2.rotation.y = -2;
            group.add(cannon2);
            
            // Personajes en posición de batalla
            const barbarossa = createAnimatedCharacter('barbarossa', group, { x: -3, y: 0, z: 3 }, 1);
            const anne = createAnimatedCharacter('anne', group, { x: 0, y: 0, z: 5 }, 1);
            const henry = createAnimatedCharacter('henry', group, { x: 4, y: 0, z: 2 }, 1);
            const skeleton = createAnimatedCharacter('skeleton', group, { x: -1, y: 0, z: 4 }, 1);
            
            // Tentáculos (inicialmente ocultos)
            const tentacle1 = createAnimatedCharacter('tentacle', group, { x: -2, y: -2, z: -5 }, 1.3);
            if (tentacle1) {
                tentacle1.model.visible = false;
                tentacle1.model.scale.set(0, 0, 0);
            }
            
            const tentacle2 = createAnimatedCharacter('enemyTentacle', group, { x: 3, y: -2, z: -4 }, 1.1);
            if (tentacle2) {
                tentacle2.model.visible = false;
                tentacle2.model.scale.set(0, 0, 0);
            }
            
            const tentacle3 = createAnimatedCharacter('tentacle', group, { x: 0, y: -2, z: -6 }, 1.2);
            if (tentacle3) {
                tentacle3.model.visible = false;
                tentacle3.model.scale.set(0, 0, 0);
            }
        }

        // ============================================
        // ESCENA 5: LA PLAYA DEL BOTÍN
        // ============================================
        function buildBeachScene() {
            const group = sceneGroups.beach;
            
            // Arena dorada
            const sandGeometry = new THREE.PlaneGeometry(200, 200);
            const sandMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xE6C288,
                roughness: 1
            });
            const sand = new THREE.Mesh(sandGeometry, sandMaterial);
            sand.rotation.x = -Math.PI / 2;
            sand.position.y = -0.1;
            sand.receiveShadow = true;
            group.add(sand);
            
            // Agua turquesa
            const waterGeometry = new THREE.PlaneGeometry(300, 200);
            const waterMaterial = new THREE.MeshStandardMaterial({
                color: 0x40E0D0,
                roughness: 0.1,
                metalness: 0.2,
                transparent: true,
                opacity: 0.85
            });
            const water = new THREE.Mesh(waterGeometry, waterMaterial);
            water.rotation.x = -Math.PI / 2;
            water.position.set(0, -0.3, 60);
            group.add(water);
            
            // Palmeras
            for (let i = 0; i < 12; i++) {
                const palmType = Math.random() > 0.6 ? 'palmTree1' : Math.random() > 0.5 ? 'palmTree2' : 'palmTree3';
                const palm = loadedModels[palmType].clone();
                palm.position.set(
                    (Math.random() - 0.5) * 80,
                    0,
                    -20 - Math.random() * 20
                );
                palm.scale.setScalar(0.9 + Math.random() * 0.5);
                palm.rotation.y = Math.random() * Math.PI * 2;
                group.add(palm);
            }
            
            // Barco anclado
            const ship = loadedModels.shipLarge.clone();
            ship.position.set(-25, -0.3, -30);
            ship.rotation.y = 0.5;
            ship.scale.set(0.9, 0.9, 0.9);
            group.add(ship);
            
            // Cofre del tesoro (centro)
            const chest = loadedModels.chestGold.clone();
            chest.position.set(0, 0, 0);
            chest.scale.set(1.3, 1.3, 1.3);
            group.add(chest);
            
            // Montones de oro
            for (let i = 0; i < 20; i++) {
                const coins = loadedModels.coins.clone();
                const angle = (i / 20) * Math.PI * 2;
                const radius = 2 + Math.random() * 3;
                coins.position.set(
                    Math.cos(angle) * radius,
                    0,
                    Math.sin(angle) * radius
                );
                coins.scale.setScalar(0.5 + Math.random() * 0.3);
                coins.rotation.y = Math.random() * Math.PI;
                group.add(coins);
            }
            
            // Bolsas de oro
            const bag1 = loadedModels.goldBag.clone();
            bag1.position.set(3, 0, 2);
            group.add(bag1);
            
            const bag2 = loadedModels.goldBag.clone();
            bag2.position.set(-2.5, 0, 3);
            bag2.rotation.y = 2;
            group.add(bag2);
            
            const bag3 = loadedModels.goldBag.clone();
            bag3.position.set(2, 0, -3);
            group.add(bag3);
            
            // Espada como trofeo
            const sword = loadedModels.sword.clone();
            sword.position.set(0, 0.5, -2);
            sword.rotation.set(0, 0, Math.PI / 2);
            group.add(sword);
            
            // Barriles (celebración)
            for (let i = 0; i < 5; i++) {
                const barrel = loadedModels.barrel.clone();
                const angle = Math.random() * Math.PI * 2;
                const radius = 6 + Math.random() * 4;
                barrel.position.set(
                    Math.cos(angle) * radius,
                    0,
                    Math.sin(angle) * radius
                );
                barrel.rotation.set(Math.random() * 0.5, Math.random() * Math.PI, Math.random() * 0.3);
                group.add(barrel);
            }
            
            // Rocas decorativas
            for (let i = 0; i < 6; i++) {
                const rock = loadedModels.rock1.clone();
                rock.position.set(
                    (Math.random() - 0.5) * 60,
                    0,
                    -30 - Math.random() * 10
                );
                rock.scale.setScalar(0.8 + Math.random() * 0.6);
                group.add(rock);
            }
            
            // Personajes celebrando
            const barbarossa = createAnimatedCharacter('barbarossa', group, { x: -2, y: 0, z: 4 }, 1);
            const anne = createAnimatedCharacter('anne', group, { x: 3, y: 0, z: 3 }, 1);
            const henry = createAnimatedCharacter('henry', group, { x: 0, y: 0, z: 5 }, 1);
            const skeleton = createAnimatedCharacter('skeleton', group, { x: 1, y: 0, z: 6 }, 1);
        }

        // ============================================
        // SISTEMA DE ANIMACIÓN
        // ============================================
        function createAnimatedCharacter(modelName, parent, position, scale = 1) {
            if (!loadedModels[modelName]) return null;
            
            const model = loadedModels[modelName].clone();
            model.position.set(position.x, position.y, position.z);
            model.scale.setScalar(scale);
            parent.add(model);
            
            const animations = loadedModels[modelName + '_animations'];
            if (!animations || animations.length === 0) return { model, mixer: null, animations: [] };
            
            const mixer = new THREE.AnimationMixer(model);
            mixers.push(mixer);
            
            const charData = {
                model,
                mixer,
                animations,
                currentAction: null,
                name: modelName
            };
            
            animatedCharacters.push(charData);
            return charData;
        }

        function playAnimation(charData, animName, loop = true) {
            if (!charData || !charData.mixer) return;
            
            const animIndex = charData.animations.findIndex(a => a.name === animName);
            if (animIndex === -1) return;
            
            const clip = charData.animations[animIndex];
            const newAction = charData.mixer.clipAction(clip);
            
            if (loop) {
                newAction.setLoop(THREE.LoopRepeat);
            } else {
                newAction.setLoop(THREE.LoopOnce);
                newAction.clampWhenFinished = true;
            }
            
            if (charData.currentAction && charData.currentAction !== newAction) {
                charData.currentAction.fadeOut(0.3);
            }
            
            newAction.reset();
            newAction.fadeIn(0.3);
            newAction.play();
            
            charData.currentAction = newAction;
        }

        // ============================================
        // SCROLL ANIMATIONS
        // ============================================
        function setupScrollAnimations() {
            gsap.registerPlugin(ScrollTrigger);
            
            // Timeline principal
            const mainTimeline = gsap.timeline({
                scrollTrigger: {
                    trigger: "#scroll-container",
                    start: "top top",
                    end: "bottom bottom",
                    scrub: 1,
                    onUpdate: (self) => {
                        scrollProgress = self.progress;
                        updateProgressBar(self.progress);
                        updateSceneFromScroll(self.progress);
                    }
                }
            });
            
            // ESCENA 1: La Tormenta (0-20%)
            // Cámara zoom dramático
            mainTimeline.to(camera.position, {
                x: 5, y: 8, z: 12,
                duration: 0.2
            }, 0);
            
            // Transición a Escena 2 (18-22%)
            // Fade to black
            mainTimeline.to('#fade-overlay', {
                opacity: 1,
                duration: 0.02
            }, 0.18);
            
            mainTimeline.call(() => {
                switchToScene(2);
            }, [], 0.20);
            
            mainTimeline.to('#fade-overlay', {
                opacity: 0,
                duration: 0.02
            }, 0.20);
            
            // Cambio de color: Tormenta → Amanecer dorado
            const sunriseColor = { r: 1, g: 0.65, b: 0.3 };
            mainTimeline.to({}, {
                duration: 0.04,
                onUpdate: function() {
                    const progress = this.progress();
                    // Interpolar de azul oscuro a dorado
                    const r = 0.1 + (1 - 0.1) * progress;
                    const g = 0.1 + (0.65 - 0.1) * progress;
                    const b = 0.18 + (0.3 - 0.18) * progress;
                    scene.background.setRGB(r, g, b);
                    scene.fog.color.setRGB(r, g, b);
                }
            }, 0.18);
            
            // ESCENA 2: El Puerto (20-40%)
            mainTimeline.to(camera.position, {
                x: 10, y: 6, z: 18,
                duration: 0.2
            }, 0.22);
            
            // Transición a Escena 3
            mainTimeline.to('#fade-overlay', {
                opacity: 1,
                duration: 0.02
            }, 0.38);
            
            mainTimeline.call(() => {
                switchToScene(3);
            }, [], 0.40);
            
            mainTimeline.to('#fade-overlay', {
                opacity: 0,
                duration: 0.02
            }, 0.40);
            
            // Cambio de color: Dorado → Verde jungla
            mainTimeline.to({}, {
                duration: 0.04,
                onUpdate: function() {
                    const progress = this.progress();
                    const r = 1 + (0.2 - 1) * progress;
                    const g = 0.65 + (0.5 - 0.65) * progress;
                    const b = 0.3 + (0.2 - 0.3) * progress;
                    scene.background.setRGB(r, g, b);
                    scene.fog.color.setRGB(r, g, b);
                }
            }, 0.38);
            
            // ESCENA 3: La Jungla (40-60%)
            mainTimeline.to(camera.position, {
                x: -5, y: 5, z: 15,
                duration: 0.2
            }, 0.42);
            
            // Transición a Escena 4
            mainTimeline.to('#fade-overlay', {
                opacity: 1,
                duration: 0.02
            }, 0.58);
            
            mainTimeline.call(() => {
                switchToScene(4);
            }, [], 0.60);
            
            mainTimeline.to('#fade-overlay', {
                opacity: 0,
                duration: 0.02
            }, 0.60);
            
            // Cambio de color: Verde → Azul oscuro cueva
            mainTimeline.to({}, {
                duration: 0.04,
                onUpdate: function() {
                    const progress = this.progress();
                    const r = 0.2 + (0.1 - 0.2) * progress;
                    const g = 0.5 + (0.1 - 0.5) * progress;
                    const b = 0.2 + (0.15 - 0.2) * progress;
                    scene.background.setRGB(r, g, b);
                    scene.fog.color.setRGB(r, g, b);
                }
            }, 0.58);
            
            // ESCENA 4: La Cueva (60-80%)
            mainTimeline.to(camera.position, {
                x: 0, y: 4, z: 10,
                duration: 0.2
            }, 0.62);
            
            // Transición a Escena 5
            mainTimeline.to('#fade-overlay', {
                opacity: 1,
                duration: 0.02
            }, 0.78);
            
            mainTimeline.call(() => {
                switchToScene(5);
            }, [], 0.80);
            
            mainTimeline.to('#fade-overlay', {
                opacity: 0,
                duration: 0.02
            }, 0.80);
            
            // Cambio de color: Azul oscuro → Dorado atardecer
            mainTimeline.to({}, {
                duration: 0.04,
                onUpdate: function() {
                    const progress = this.progress();
                    const r = 0.1 + (1 - 0.1) * progress;
                    const g = 0.1 + (0.8 - 0.1) * progress;
                    const b = 0.15 + (0.4 - 0.15) * progress;
                    scene.background.setRGB(r, g, b);
                    scene.fog.color.setRGB(r, g, b);
                }
            }, 0.78);
            
            // ESCENA 5: La Playa (80-100%)
            mainTimeline.to(camera.position, {
                x: 8, y: 8, z: 12,
                duration: 0.1
            }, 0.82);
            
            mainTimeline.to(camera.position, {
                x: 0, y: 12, z: 20,
                duration: 0.1
            }, 0.90);
            
            // Setup text animations
            setupTextAnimations();
            
            ScrollTrigger.refresh();
        }

        function switchToScene(sceneNum) {
            // Ocultar todas las escenas
            sceneGroups.storm.visible = false;
            sceneGroups.port.visible = false;
            sceneGroups.jungle.visible = false;
            sceneGroups.cave.visible = false;
            sceneGroups.beach.visible = false;
            
            // Mostrar escena actual
            switch(sceneNum) {
                case 1:
                    sceneGroups.storm.visible = true;
                    break;
                case 2:
                    sceneGroups.port.visible = true;
                    break;
                case 3:
                    sceneGroups.jungle.visible = true;
                    break;
                case 4:
                    sceneGroups.cave.visible = true;
                    break;
                case 5:
                    sceneGroups.beach.visible = true;
                    break;
            }
            
            currentScene = sceneNum;
            updateNavigationDots(sceneNum - 1);
            
            // Actualizar luces según escena
            updateLightsForScene(sceneNum);
            
            // Actualizar texto de la escena
            updateSceneText(sceneNum);
        }
        
        function updateSceneText(sceneNum) {
            // Ocultar todos los textos
            for (let i = 1; i <= 5; i++) {
                const textEl = document.getElementById(`scene-text-${i}`);
                if (textEl) textEl.classList.remove('visible');
            }
            
            // Mostrar texto de la escena actual
            const currentTextEl = document.getElementById(`scene-text-${sceneNum}`);
            if (currentTextEl) currentTextEl.classList.add('visible');
        }

        function updateLightsForScene(sceneNum) {
            switch(sceneNum) {
                case 1: // Tormenta - iluminación por relámpagos intermitentes
                    lights.ambient.color.setHex(0x1a1a2e);
                    lights.ambient.intensity = 0.3;
                    lights.moon.color.setHex(0xa8d8ea);
                    lights.moon.intensity = 0.4;
                    break;
                case 2: // Puerto amanecer
                    lights.ambient.color.setHex(0xfff5e6);
                    lights.ambient.intensity = 0.6;
                    lights.moon.color.setHex(0xffd700);
                    lights.moon.intensity = 1.2;
                    break;
                case 3: // Jungla
                    lights.ambient.color.setHex(0x1a2f1a);
                    lights.ambient.intensity = 0.4;
                    lights.moon.color.setHex(0x4a7c59);
                    lights.moon.intensity = 0.8;
                    break;
                case 4: // Cueva
                    lights.ambient.color.setHex(0x0a0a1a);
                    lights.ambient.intensity = 0.2;
                    lights.moon.color.setHex(0x4a0080);
                    lights.moon.intensity = 0.3;
                    break;
                case 5: // Playa atardecer
                    lights.ambient.color.setHex(0xfff5e6);
                    lights.ambient.intensity = 0.7;
                    lights.moon.color.setHex(0xff6b35);
                    lights.moon.intensity = 1.0;
                    break;
            }
        }

        function setupTextAnimations() {
            const sections = document.querySelectorAll('.story-section');
            const overlays = document.querySelectorAll('.text-overlay');
            
            sections.forEach((section, index) => {
                ScrollTrigger.create({
                    trigger: section,
                    start: "top 60%",
                    end: "bottom 40%",
                    onEnter: () => {
                        overlays[index].classList.add('visible');
                    },
                    onLeave: () => {
                        overlays[index].classList.remove('visible');
                    },
                    onEnterBack: () => {
                        overlays[index].classList.add('visible');
                    },
                    onLeaveBack: () => {
                        overlays[index].classList.remove('visible');
                    }
                });
            });
        }

        function updateProgressBar(progress) {
            const fill = document.getElementById('progress-fill');
            if (fill) fill.style.width = `${progress * 100}%`;
        }

        function updateSceneFromScroll(progress) {
            const sceneIndex = Math.min(4, Math.floor(progress * 5));
            if (sceneIndex !== currentScene - 1) {
                updateNavigationDots(sceneIndex);
            }
        }

        function setupNavigationDots() {
            const dots = document.querySelectorAll('.nav-dot');
            const container = document.getElementById('scroll-container');
            
            dots.forEach((dot, index) => {
                dot.addEventListener('click', () => {
                    const targetProgress = index / 5;
                    const targetScroll = targetProgress * (container.scrollHeight - window.innerHeight);
                    window.scrollTo({ top: targetScroll, behavior: 'smooth' });
                });
            });
        }

        function updateNavigationDots(sceneIndex) {
            const dots = document.querySelectorAll('.nav-dot');
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === sceneIndex);
            });
        }

        function restartStory() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            updateNavigationDots(0);
            switchToScene(1);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // ============================================
        // LOOP PRINCIPAL
        // ============================================
        function animate() {
            animationId = requestAnimationFrame(animate);
            
            const time = Date.now() * 0.001;
            stormTime += 0.016;
            
            // Actualizar mixers
            mixers.forEach(mixer => mixer.update(0.016));
            
            // EFECTOS ESCENA 1: La Tormenta
            if (currentScene === 1 && sceneGroups.storm.visible) {
                // Animar lluvia
                if (rainSystem && rainSystem.userData.velocities) {
                    const positions = rainSystem.geometry.attributes.position.array;
                    const velocities = rainSystem.userData.velocities;
                    
                    for (let i = 0; i < velocities.length; i++) {
                        positions[i * 3] += velocities[i].x; // Viento
                        positions[i * 3 + 1] += velocities[i].y; // Caída
                        positions[i * 3 + 2] += velocities[i].z;
                        
                        // Reset si cae demasiado bajo
                        if (positions[i * 3 + 1] < -5) {
                            positions[i * 3 + 1] = 30 + Math.random() * 10;
                            positions[i * 3] = (Math.random() - 0.5) * 80;
                            positions[i * 3 + 2] = (Math.random() - 0.5) * 80;
                        }
                    }
                    rainSystem.geometry.attributes.position.needsUpdate = true;
                }
                               
                // Relámpagos intermitentes
                if (Math.random() < 0.02) { // 2% de probabilidad por frame
                    lightningLight.intensity = 2 + Math.random() * 2;
                    setTimeout(() => {
                        lightningLight.intensity = 0;
                    }, 100 + Math.random() * 150);
                }
                
                // Barco meciéndose
                if (shipInStorm) {
                    shipInStorm.rotation.z = Math.sin(time * 0.8) * 0.08;
                    shipInStorm.rotation.x = Math.sin(time * 1.2) * 0.05;
                    shipInStorm.position.y = Math.sin(time * 0.6) * 0.3;
                }
                
                // El capitán es hijo del grupo de la escena, no necesita sincronización manual
                // Solo actualizar skeleton si es necesario
                if (window.barbarossaInStorm && window.barbarossaInStorm.model) {
                    window.barbarossaInStorm.model.traverse((child) => {
                        if (child.isSkinnedMesh && child.skeleton) {
                            child.skeleton.update();
                        }
                    });
                    
                    // La cámara mira al capitán (obtener posición mundial)
                    const captainPos = new THREE.Vector3();
                    window.barbarossaInStorm.model.getWorldPosition(captainPos);
                    camera.lookAt(captainPos);
                }
            }
            
            // Agua en todas las escenas
            scene.traverse((object) => {
                if (object.isMesh && object.material && object.material.color) {
                    // Animar agua si es azul
                    if (object.material.color.getHex() === 0x001f3f || 
                        object.material.color.getHex() === 0x40E0D0 ||
                        object.material.color.getHex() === 0x006994) {
                        object.position.y = -0.5 + Math.sin(time * 0.5) * 0.1;
                    }
                }
            });
            
            renderer.render(scene, camera);
        }

        // Iniciar
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
