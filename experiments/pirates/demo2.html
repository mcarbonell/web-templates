<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Dead Man's Deal - Pirate Scene</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050510;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #d4af37;
            font-family: 'Courier New', Courier, monospace;
            font-size: 24px;
            pointer-events: none;
            text-shadow: 0 0 10px #d4af37;
            transition: opacity 0.5s;
        }
    </style>
</head>

<body>
    <div id="loading">Loading The Dead Man's Deal...</div>
    <div id="canvas-container"></div>

    <!-- Import maps polyfill -->
    <script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { Water } from 'three/addons/objects/Water.js';

        // --- Scene Setup ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050510);
        scene.fog = new THREE.FogExp2(0x050510, 0.025);

        const camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(8, 4, 8); // Slightly lower angle

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.0;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // --- Controls ---
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.maxPolarAngle = Math.PI / 2 - 0.1; // Don't go below water
        controls.minDistance = 2;
        controls.maxDistance = 25;
        controls.target.set(0, 1, 0);

        // --- Lighting ---
        const ambientLight = new THREE.AmbientLight(0x0b0b15, 0.5); // Very dark ambient
        scene.add(ambientLight);

        // Moonlight
        const moonLight = new THREE.DirectionalLight(0x88bbff, 1.5);
        moonLight.position.set(-20, 30, -10);
        moonLight.castShadow = true;
        moonLight.shadow.mapSize.width = 2048;
        moonLight.shadow.mapSize.height = 2048;
        moonLight.shadow.camera.near = 0.5;
        moonLight.shadow.camera.far = 100;
        moonLight.shadow.camera.left = -30;
        moonLight.shadow.camera.right = 30;
        moonLight.shadow.camera.top = 30;
        moonLight.shadow.camera.bottom = -30;
        moonLight.shadow.bias = -0.0001;
        scene.add(moonLight);

        // Warm Lantern Light (The "Deal" spot)
        const lanternLight = new THREE.PointLight(0xffaa33, 8, 12);
        lanternLight.position.set(0, 2, 0);
        lanternLight.castShadow = true;
        lanternLight.shadow.bias = -0.0001;
        scene.add(lanternLight);

        // --- Environment ---

        // Water
        const waterGeometry = new THREE.PlaneGeometry(200, 200);
        const water = new Water(
            waterGeometry,
            {
                textureWidth: 512,
                textureHeight: 512,
                waterNormals: new THREE.TextureLoader().load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/water/waternormals.jpg', function (texture) {
                    texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
                }),
                sunDirection: new THREE.Vector3(),
                sunColor: 0xffffff,
                waterColor: 0x001e0f,
                distortionScale: 3.7,
                fog: scene.fog !== undefined
            }
        );
        water.rotation.x = - Math.PI / 2;
        water.position.y = -0.2; // Slightly below 0 to avoid z-fighting with dock bottom if any
        scene.add(water);

        // --- Assets ---
        const loader = new GLTFLoader();
        const basePath = '../../assets/3D/pirate-kit/glTF/';
        const mixers = [];
        const clock = new THREE.Clock();

        const assets = [
            // Environment
            { name: 'Dock', file: 'Environment_Dock.gltf', pos: [0, 0, 0], scale: 1 },
            { name: 'Dock2', file: 'Environment_Dock.gltf', pos: [0, 0, 3.8], rot: [0, Math.PI, 0], scale: 1 }, // Extend dock
            { name: 'BrokenDock', file: 'Environment_Dock_Broken.gltf', pos: [0, 0, 7.6], rot: [0, 0, 0], scale: 1 },
            { name: 'Ship', file: 'Ship_Large.gltf', pos: [-12, 0, -8], rot: [0, 0.4, 0.05], scale: 1 },
            { name: 'Cliff', file: 'Environment_Cliff1.gltf', pos: [15, -2, -15], rot: [0, -0.5, 0], scale: 4 },

            // Characters
            { name: 'Captain', file: 'Characters_Captain_Barbarossa.gltf', pos: [0.5, 0, 1], rot: [0, -1.8, 0], scale: 1, anim: 'Idle' },
            { name: 'Skeleton', file: 'Characters_Skeleton.gltf', pos: [-0.5, 0, 1], rot: [0, 1.8, 0], scale: 1, anim: 'Idle' },
            { name: 'Shark', file: 'Characters_Shark.gltf', pos: [6, -1.5, 4], rot: [0, 0, 0], scale: 1, anim: 'Swim' },

            // Props
            { name: 'Chest', file: 'Prop_Chest_Gold.gltf', pos: [0, 0, 0], rot: [0, 0.2, 0], scale: 1 },
            { name: 'Barrel', file: 'Prop_Barrel.gltf', pos: [1.5, 0, 2], rot: [0, 0, 0], scale: 1 },
            { name: 'Lantern', file: 'Prop_Bucket.gltf', pos: [1.2, 0, 0.5], rot: [0, -0.2, 0], scale: 0.8 }, // Bucket as lantern stand
            { name: 'Skull', file: 'Prop_Skull.gltf', pos: [-1.5, 0, 2.5], rot: [0, -0.5, 0], scale: 1 }
        ];

        // Global logic variables
        const logic = {
            shark: null,
            ship: null,
            loadedCount: 0
        };

        // Load Loop
        assets.forEach(asset => {
            loader.load(
                basePath + asset.file,
                (gltf) => {
                    const model = gltf.scene;

                    // Transform
                    if (asset.pos) model.position.set(...asset.pos);
                    if (asset.rot) model.rotation.set(...asset.rot);
                    if (asset.scale) model.scale.set(asset.scale, asset.scale, asset.scale);

                    // Shadows
                    model.traverse((child) => {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                            // Make materials fully opaque to avoid sorting issues with loose transparency
                            if (child.material) {
                                child.material.transparent = false;
                                child.material.alphaTest = 0.5;
                            }
                        }
                    });

                    scene.add(model);

                    // Animation
                    if (asset.anim && gltf.animations.length > 0) {
                        const mixer = new THREE.AnimationMixer(model);
                        // Try to find exact animation, else random one?
                        // For this demo, let's try to find 'Idle' variants if exact not found
                        let clip = THREE.AnimationClip.findByName(gltf.animations, asset.anim);
                        if (!clip && asset.anim === 'Idle') {
                            clip = gltf.animations.find(a => a.name.includes('Idle'));
                        }
                        if (!clip) clip = gltf.animations[0]; // Fallback

                        if (clip) {
                            const action = mixer.clipAction(clip);
                            action.play();
                            // Randomize start time to avoid sync
                            action.time = Math.random() * clip.duration;
                            mixers.push(mixer);
                        }
                    }

                    // Special Logic Linking
                    if (asset.name === 'Shark') {
                        model.userData = { angle: 0, radius: 8, speed: 0.4, yBase: -1.5 };
                        logic.shark = model;
                    }
                    if (asset.name === 'Ship') {
                        model.userData = { yBase: -0.5, timeOffset: Math.random() * 100 };
                        logic.ship = model;
                    }

                    // Progress
                    logic.loadedCount++;
                    if (logic.loadedCount === assets.length) {
                        const loadingEl = document.getElementById('loading');
                        loadingEl.style.opacity = 0;
                        setTimeout(() => loadingEl.style.display = 'none', 500);
                    }
                },
                undefined,
                (err) => console.error('Error loading ' + asset.file, err)
            );
        });

        // --- Animation Loop ---
        function animate() {
            requestAnimationFrame(animate);

            const delta = clock.getDelta();
            const time = clock.getElapsedTime();

            // Update Mixers
            mixers.forEach(mixer => mixer.update(delta));

            // Water
            water.material.uniforms['time'].value += 1.0 / 60.0;

            // Shark Logic
            if (logic.shark) {
                const s = logic.shark;
                s.userData.angle += s.userData.speed * delta;
                s.position.x = Math.cos(s.userData.angle) * s.userData.radius;
                s.position.z = Math.sin(s.userData.angle) * s.userData.radius;
                s.position.y = s.userData.yBase + Math.sin(time * 2) * 0.1;
                s.rotation.y = -s.userData.angle; // Face forward
            }

            // Ship Logic
            if (logic.ship) {
                const s = logic.ship;
                const t = time + s.userData.timeOffset;
                s.position.y = s.userData.yBase + Math.sin(t * 0.5) * 0.2;
                s.rotation.z = 0.05 + Math.sin(t * 0.3) * 0.02; // Mild roll
                s.rotation.x = Math.cos(t * 0.2) * 0.01; // Mild pitch
            }

            // Lantern flicker
            lanternLight.intensity = 6 + Math.sin(time * 12) * 2 + Math.random() * 1;

            // Camera subtle move if idle? (Optional, skipping for now to let user control)

            controls.update();
            renderer.render(scene, camera);
        }

        animate();

        // --- Resize ---
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>

</html>